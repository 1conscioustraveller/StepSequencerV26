<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kick Test â€” Optimized Scheduler</title>
<style>
  body { background:#0b1220; color:#dff7ff; font-family:system-ui; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; margin:0 }
  button { border:1px solid rgba(32,224,255,0.25); background:transparent; color:#20e0ff; padding:12px 18px; border-radius:12px; cursor:pointer; font-size:18px }
  button:active { transform:translateY(1px) }
  .active { background:rgba(32,224,255,0.25); box-shadow:0 0 12px rgba(32,224,255,0.6) inset }
</style>
</head>
<body>
  <button id="playBtn">Play</button>

<script>
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
const master = audioCtx.createGain();
master.gain.value = 0.8;
master.connect(audioCtx.destination);

function playKick(time){
  // Clear sine beep (440 Hz, short duration)
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = 440;
  gain.gain.setValueAtTime(1, time);
  gain.gain.exponentialRampToValueAtTime(0.001, time + 0.15);
  osc.connect(gain).connect(master);
  osc.start(time);
  osc.stop(time + 0.15);
}

let isRunning = false;
let nextNoteTime = 0;
let currentStep = 0;
let scheduleTimer = null;
let lookahead = 0.1;
let scheduleInterval = 25; // ms
const sps = (60 / 120) / 2; // step = 8th note at 120 BPM

function schedulerTick(){
  const now = audioCtx.currentTime;
  while (nextNoteTime < now + lookahead) {
    playKick(nextNoteTime + 0.0005);
    // immediately toggle visual state for this step
    const btn = document.getElementById('playBtn');
    btn.classList.add('active');
    setTimeout(()=>btn.classList.remove('active'), 80);
    nextNoteTime += sps;
    currentStep = (currentStep + 1) % 64;
  }
}

document.getElementById('playBtn').addEventListener('click', async ()=>{
  if(audioCtx.state === 'suspended') await audioCtx.resume();
  if(isRunning) return;
  isRunning = true;
  nextNoteTime = audioCtx.currentTime + 0.05;
  scheduleTimer = setInterval(schedulerTick, scheduleInterval);
});

</script>
</body>
</html>
